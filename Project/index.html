<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEURO-STIM v8.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #000; --panel: #0a0a0c; --accent: #00f2ff; --accent-glow: rgba(0, 242, 255, 0.4);
            --danger: #ff0044; --success: #00ff88; --text: #fff; --border: #1a1a1e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--bg); color: var(--text);
            height: 100dvh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }
        header {
            padding: 15px 25px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--accent); background: #000;
        }
        .logo { font-size: clamp(1rem, 3vw, 1.4rem); font-weight: 900; letter-spacing: 4px; color: var(--accent); }
        .stats-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px; background: var(--border); }
        .stat-card { background: var(--panel); padding: clamp(10px, 4vh, 25px); text-align: center; }
        .label { font-size: 0.65rem; color: var(--accent); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px; }
        .value { font-size: clamp(1.2rem, 6vw, 2rem); font-weight: 900; font-family: 'Courier New', monospace; }
        .main-view { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; background: radial-gradient(circle at center, #0d0d0f 0%, #000 100%); }
        .nav-tabs { display: flex; justify-content: center; gap: 12px; margin-bottom: 15px; }
        .tab-btn { background: #111; border: 1px solid #333; color: #666; padding: 8px 20px; border-radius: 8px; font-size: 0.75rem; font-weight: bold; cursor: pointer; }
        .tab-btn.active { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .chart-wrap { flex-grow: 1; width: 100%; position: relative; }
        .control-deck { background: var(--panel); border-top: 3px solid var(--accent); display: flex; align-items: center; justify-content: space-around; padding: 20px 10px calc(20px + env(safe-area-inset-bottom)); gap: 10px; }
        .deck-element { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .sos-btn { width: 100%; max-width: 120px; padding: clamp(15px, 3vh, 30px) 10px; border-radius: 15px; border: 2px solid var(--accent); background: none; color: var(--accent); font-weight: 900; font-size: clamp(0.7rem, 2vw, 1rem); }
        #btn-log { width: clamp(90px, 25vw, 140px); height: clamp(90px, 25vw, 140px); border-radius: 50%; border: 5px solid var(--danger); background: none; color: var(--danger); font-weight: 900; font-size: clamp(0.8rem, 2.5vw, 1.1rem); box-shadow: 0 0 25px rgba(255, 0, 68, 0.3); display: flex; align-items: center; justify-content: center; text-align: center; }
        .chrono-wrap { text-align: center; min-width: clamp(100px, 20vw, 150px); }
        .chrono-time { font-size: clamp(1rem, 3.5vw, 1.5rem); font-weight: 900; font-family: monospace; }
        .health-hint { font-size: 0.55rem; color: var(--success); text-transform: uppercase; margin-top: 5px; font-weight: bold; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-body { background: #0a0a0c; border: 2px solid var(--accent); padding: 30px; border-radius: 25px; width: 90%; max-width: 450px; }
        input { width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: #fff; margin: 10px 0 20px; border-radius: 12px; font-size: 1.2rem; }
        @keyframes pulse-danger { 0%, 100% { box-shadow: 0 0 10px var(--danger); } 50% { box-shadow: 0 0 30px var(--danger); } }
        .over-goal { animation: pulse-danger 1.5s infinite; }
    </style>
</head>
<body>

    <header>
        <div class="logo">NEURO_STIM <span style="font-weight:200">APEX</span></div>
        <button onclick="openSettings()" style="background:none; border:none; color:var(--accent); font-size:1.6rem">⚙️</button>
    </header>

    <div class="stats-container">
        <div class="stat-card"><span class="label">Dépense Totale</span><div class="value" id="ui-spent" style="color:var(--danger)">0.00€</div></div>
        <div class="stat-card"><span class="label" id="ui-label-avg">Moyenne 7j</span><div class="value" id="ui-avg">0.0</div></div>
        <div class="stat-card"><span class="label">Aujourd'hui</span><div class="value" id="ui-today">0</div></div>
        <div class="stat-card"><span class="label">Tendance</span><div class="value" id="ui-trend">--</div></div>
    </div>

    <main class="main-view">
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="setPeriod('7j', this)">7 JOURS</button>
            <button class="tab-btn" onclick="setPeriod('30j', this)">30 JOURS</button>
            <button class="tab-btn" onclick="setPeriod('1an', this)">1 AN</button>
        </div>
        <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
    </main>

    <footer class="control-deck">
        <div class="deck-element"><button class="sos-btn" id="sos-btn" onclick="sosLaunch()">SOS<br>ENVIE</button></div>
        <div class="deck-element"><button id="btn-log" onclick="addEntry()">LOG<br>CIG</button></div>
        <div class="deck-element chrono-wrap"><span class="label">Depuis</span><div class="chrono-time" id="ui-chrono">00:00:00</div><div class="health-hint" id="ui-health">Initialisation...</div></div>
    </footer>

    <div id="modal-settings" class="modal">
        <div class="modal-body">
            <h2 style="color:var(--accent); text-align:center; margin-bottom:20px">PARAMÈTRES</h2>
            <label class="label">Prix du Paquet (€)</label><input type="number" step="0.01" id="in-price">
            <label class="label">Cigarettes / Paquet</label><input type="number" id="in-count">
            <label class="label">Objectif Max / Jour</label><input type="number" id="in-goal">
            <label class="label">Défi SOS (Minutes)</label><input type="number" id="in-sos">
            <button class="tab-btn active" style="width:100%; padding:20px; font-size:1rem; margin-bottom:15px" onclick="saveSettings()">ENREGISTRER</button>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <button class="tab-btn" onclick="exportData()">EXPORT</button>
                <button class="tab-btn" onclick="document.getElementById('file-in').click()">IMPORT</button>
            </div>
            <input type="file" id="file-in" style="display:none" onchange="importData(event)">
            <button class="tab-btn" style="width:100%; margin-top:20px; border:none" onclick="closeSettings()">FERMER</button>
            <button onclick="fullReset()" style="width:100%; margin-top:15px; color:var(--danger); background:none; border:none; font-size:0.6rem; cursor:pointer">RÉINITIALISATION TOTALE</button>
        </div>
    </div>

<script>
    let state = { records: [], goal: 10, sosMin: 5, packPrice: 12.50, packCount: 20 };
    let chart = null;
    let period = '7j';
    
    // Cache de calcul pour éviter de reparcourir records sans arrêt
    let cachedStats = { today: 0, totalSpent: 0, dailyMap: {}, lastTs: 0 };

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSFX(t) {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = (t==='click'?800:150);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (t==='click'?0.1:0.3));
        o.start(); o.stop(audioCtx.currentTime + (t==='click'?0.1:0.3));
    }

    function init() {
        const saved = localStorage.getItem('neuro_stim_v8_1');
        if (saved) state = JSON.parse(saved);
        processData(); // Calcul unique au chargement
        refreshUI();
        setInterval(updateChrono, 1000);
    }

    // --- OPTIMISATION : UN SEUL PASSAGE SUR LES DONNÉES ---
    function processData() {
        const todayStr = new Date().toDateString();
        cachedStats = { today: 0, totalSpent: 0, dailyMap: {}, lastTs: 0 };
        
        for (let i = 0; i < state.records.length; i++) {
            const r = state.records[i];
            const d = new Date(r.ts);
            const dStr = d.toDateString();
            
            // 1. Agrégation pour le graphique
            cachedStats.dailyMap[dStr] = (cachedStats.dailyMap[dStr] || 0) + 1;
            
            // 2. Stats directes
            if (dStr === todayStr) cachedStats.today++;
            cachedStats.totalSpent += r.p;
            if (r.ts > cachedStats.lastTs) cachedStats.lastTs = r.ts;
        }
    }

    function addEntry() {
        playSFX('log');
        state.records.push({ ts: Date.now(), p: (state.packPrice / state.packCount) });
        localStorage.setItem('neuro_stim_v8_1', JSON.stringify(state));
        processData(); // Recalculer après ajout
        refreshUI();
    }

    function refreshUI() {
        // UI de base
        document.getElementById('ui-today').innerText = cachedStats.today;
        document.getElementById('ui-spent').innerText = cachedStats.totalSpent.toFixed(2) + "€";
        
        const btnLog = document.getElementById('btn-log');
        btnLog.classList.toggle('over-goal', cachedStats.today > state.goal);

        // Tendance et Moyenne (basées sur les dates, pas sur un slice du tableau)
        const days = (period === '7j' ? 7 : period === '30j' ? 30 : 365);
        document.getElementById('ui-label-avg').innerText = "Moyenne " + period;
        
        let currentPeriodCount = 0;
        let prevPeriodCount = 0;
        const now = new Date();
        
        // On calcule la moyenne sur les X derniers jours calendaires
        for (let i = 0; i < days; i++) {
            let d = new Date(); d.setDate(now.getDate() - i);
            currentPeriodCount += (cachedStats.dailyMap[d.toDateString()] || 0);
            
            let dPrev = new Date(); dPrev.setDate(now.getDate() - (i + days));
            prevPeriodCount += (cachedStats.dailyMap[dPrev.toDateString()] || 0);
        }

        document.getElementById('ui-avg').innerText = (currentPeriodCount / days).toFixed(1);
        const trend = document.getElementById('ui-trend');
        if (currentPeriodCount < prevPeriodCount) { trend.innerText = "BAISSE ↓"; trend.style.color = "var(--success)"; }
        else if (currentPeriodCount > prevPeriodCount) { trend.innerText = "HAUSSE ↑"; trend.style.color = "var(--danger)"; }
        else { trend.innerText = "STABLE ="; trend.style.color = "var(--accent)"; }

        renderChart(days);
    }

    function renderChart(days) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();

        const labels = [], values = [], colors = [];
        const now = new Date();

        for (let i = days - 1; i >= 0; i--) {
            let d = new Date(); d.setDate(now.getDate() - i);
            let dStr = d.toDateString();
            let count = cachedStats.dailyMap[dStr] || 0;
            
            labels.push(days === 365 ? (i % 60 === 0 ? d.getDate()+'/'+(d.getMonth()+1) : '') : d.getDate().toString());
            values.push(count);
            colors.push(count > state.goal ? '#ff0044' : '#00ff88');
        }

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: values, borderColor: '#00f2ff', borderWidth: 2,
                    pointBackgroundColor: colors, pointRadius: days > 30 ? 0 : 5,
                    tension: 0.3, fill: true, backgroundColor: 'rgba(0, 242, 255, 0.05)'
                }, {
                    data: Array(days).fill(state.goal), borderColor: 'rgba(255, 0, 68, 0.4)',
                    borderDash: [5, 5], borderWidth: 1, pointRadius: 0
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: days <= 30 } },
                scales: { 
                    y: { beginAtZero: true, grid: { color: '#1a1a1e' }, ticks: { color: '#00f2ff' } },
                    x: { grid: { display: false }, ticks: { color: '#444', font: { size: 10 } } }
                }
            }
        });
    }

    function updateChrono() {
        if (cachedStats.lastTs === 0) return;
        const diff = Math.floor((Date.now() - cachedStats.lastTs) / 1000);
        const h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60), s = diff%60;
        document.getElementById('ui-chrono').innerText = `${h<10?'0':''}${h}:${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
        
        const hint = document.getElementById('ui-health');
        if(diff < 28800) hint.innerText = "Élimination CO...";
        else if(diff < 86400) hint.innerText = "Poumons se libèrent";
        else hint.innerText = "Récupération active";
    }

    function setPeriod(p, b) { 
        playSFX('click'); period = p; 
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active'); refreshUI(); 
    }

    function sosLaunch() {
        playSFX('click'); const b = document.getElementById('sos-btn'); b.disabled = true;
        let s = state.sosMin * 60;
        const t = setInterval(() => {
            b.innerText = `${Math.floor(s/60)}:${(s%60<10?'0':'')}${s%60}`;
            if(s-- <= 0) { clearInterval(t); b.disabled = false; b.innerText = "SOS\nENVIE"; alert("BIEN JOUÉ ! L'envie est passée."); }
        }, 1000);
    }

    function openSettings() {
        document.getElementById('in-price').value = state.packPrice;
        document.getElementById('in-count').value = state.packCount;
        document.getElementById('in-goal').value = state.goal;
        document.getElementById('in-sos').value = state.sosMin;
        document.getElementById('modal-settings').style.display = 'flex';
    }
    function closeSettings() { document.getElementById('modal-settings').style.display = 'none'; }
    function saveSettings() {
        state.packPrice = parseFloat(document.getElementById('in-price').value) || 12.5;
        state.packCount = parseInt(document.getElementById('in-count').value) || 20;
        state.goal = parseInt(document.getElementById('in-goal').value) || 10;
        state.sosMin = parseInt(document.getElementById('in-sos').value) || 5;
        localStorage.setItem('neuro_stim_v8_1', JSON.stringify(state));
        processData(); refreshUI(); closeSettings();
    }
    function exportData() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], {type:"application/json"}));
        a.download = "neuro_stim_data.json"; a.click();
    }
    function importData(e) {
        const r = new FileReader();
        r.onload = (x) => { state = JSON.parse(x.target.result); processData(); refreshUI(); closeSettings(); };
        r.readAsText(e.target.files[0]);
    }
    function fullReset() { if(confirm("Supprimer tout l'historique ?")) { localStorage.clear(); location.reload(); } }

    window.onload = init;
</script>
</body>
</html>
